<!DOCTYPE html>
<html>
  <head>
    <title>Compare</title>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/jsondiffpatch.umd.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.19/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <style>
      .buttons {
        position: sticky;
        bottom: 0;
        background: white;
        display: flex;
      }

      .buttons .btn {
        flex-grow: 1;
      }

      .change {
        padding: 10px;
        margin: 10px;
        border: solid black 2px;
      }

      .change[data-quality="unscored"],
      .scoreboard .unscored {
        background: beige;
      }

      .change[data-quality="better"],
      .scoreboard .better {
        background: lightgreen;
      }

      .change[data-quality="worse"],
      .scoreboard .worse {
        background: lightcoral;
      }

      .change[data-quality="neutral"],
      .scoreboard .neutral {
        background: lightgrey;
      }

      .request-card {
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      #scoreboard {
        position: fixed;
        top: 0;
        right: 0;
        z-index: 10000;
      }

      /* https://benjamine.github.io/jsondiffpatch/formatters-styles/html.css */

      .jsondiffpatch-delta {
        font-family: "Bitstream Vera Sans Mono", "DejaVu Sans Mono", Monaco, Courier, monospace;
        font-size: 12px;
        margin: 0;
        padding: 0 0 0 12px;
        display: inline-block;
      }
      .jsondiffpatch-delta pre {
        font-family: "Bitstream Vera Sans Mono", "DejaVu Sans Mono", Monaco, Courier, monospace;
        font-size: 12px;
        margin: 0;
        padding: 0;
        display: inline-block;
      }
      ul.jsondiffpatch-delta {
        list-style-type: none;
        padding: 0 0 0 20px;
        margin: 0;
      }
      .jsondiffpatch-delta ul {
        list-style-type: none;
        padding: 0 0 0 20px;
        margin: 0;
      }
      .jsondiffpatch-added .jsondiffpatch-property-name,
      .jsondiffpatch-added .jsondiffpatch-value pre,
      .jsondiffpatch-modified .jsondiffpatch-right-value pre,
      .jsondiffpatch-textdiff-added {
        background: #bbffbb;
      }
      .jsondiffpatch-deleted .jsondiffpatch-property-name,
      .jsondiffpatch-deleted pre,
      .jsondiffpatch-modified .jsondiffpatch-left-value pre,
      .jsondiffpatch-textdiff-deleted {
        background: #ffbbbb;
        text-decoration: line-through;
      }
      .jsondiffpatch-unchanged,
      .jsondiffpatch-movedestination {
        color: gray;
      }
      .jsondiffpatch-unchanged,
      .jsondiffpatch-movedestination > .jsondiffpatch-value {
        transition: all 0.5s;
        -webkit-transition: all 0.5s;
        overflow-y: hidden;
      }
      .jsondiffpatch-unchanged-showing .jsondiffpatch-unchanged,
      .jsondiffpatch-unchanged-showing .jsondiffpatch-movedestination > .jsondiffpatch-value {
        max-height: 100px;
      }
      .jsondiffpatch-unchanged-hidden .jsondiffpatch-unchanged,
      .jsondiffpatch-unchanged-hidden .jsondiffpatch-movedestination > .jsondiffpatch-value {
        max-height: 0;
      }
      .jsondiffpatch-unchanged-hiding .jsondiffpatch-movedestination > .jsondiffpatch-value,
      .jsondiffpatch-unchanged-hidden .jsondiffpatch-movedestination > .jsondiffpatch-value {
        display: block;
      }
      .jsondiffpatch-unchanged-visible .jsondiffpatch-unchanged,
      .jsondiffpatch-unchanged-visible .jsondiffpatch-movedestination > .jsondiffpatch-value {
        max-height: 100px;
      }
      .jsondiffpatch-unchanged-hiding .jsondiffpatch-unchanged,
      .jsondiffpatch-unchanged-hiding .jsondiffpatch-movedestination > .jsondiffpatch-value {
        max-height: 0;
      }
      .jsondiffpatch-unchanged-showing .jsondiffpatch-arrow,
      .jsondiffpatch-unchanged-hiding .jsondiffpatch-arrow {
        display: none;
      }
      .jsondiffpatch-value {
        display: inline-block;
      }
      .jsondiffpatch-property-name {
        display: inline-block;
        padding-right: 5px;
        vertical-align: top;
      }
      .jsondiffpatch-property-name:after {
        content: ": ";
      }
      .jsondiffpatch-child-node-type-array > .jsondiffpatch-property-name:after {
        content: ": [";
      }
      .jsondiffpatch-child-node-type-array:after {
        content: "],";
      }
      div.jsondiffpatch-child-node-type-array:before {
        content: "[";
      }
      div.jsondiffpatch-child-node-type-array:after {
        content: "]";
      }
      .jsondiffpatch-child-node-type-object > .jsondiffpatch-property-name:after {
        content: ": {";
      }
      .jsondiffpatch-child-node-type-object:after {
        content: "},";
      }
      div.jsondiffpatch-child-node-type-object:before {
        content: "{";
      }
      div.jsondiffpatch-child-node-type-object:after {
        content: "}";
      }
      .jsondiffpatch-value pre:after {
        content: ",";
      }
      li:last-child > .jsondiffpatch-value pre:after,
      .jsondiffpatch-modified > .jsondiffpatch-left-value pre:after {
        content: "";
      }
      .jsondiffpatch-modified .jsondiffpatch-value {
        display: inline-block;
      }
      .jsondiffpatch-modified .jsondiffpatch-right-value {
        margin-left: 5px;
      }
      .jsondiffpatch-moved .jsondiffpatch-value {
        display: none;
      }
      .jsondiffpatch-moved .jsondiffpatch-moved-destination {
        display: inline-block;
        background: #ffffbb;
        color: #888;
      }
      .jsondiffpatch-moved .jsondiffpatch-moved-destination:before {
        content: " => ";
      }
      ul.jsondiffpatch-textdiff {
        padding: 0;
      }
      .jsondiffpatch-textdiff-location {
        color: #bbb;
        display: inline-block;
        min-width: 60px;
      }
      .jsondiffpatch-textdiff-line {
        display: inline-block;
      }
      .jsondiffpatch-textdiff-line-number:after {
        content: ",";
      }
      .jsondiffpatch-error {
        background: red;
        color: white;
        font-weight: bold;
      }

      /* https://benjamine.github.io/jsondiffpatch/formatters-styles/annotated.css */
      .jsondiffpatch-annotated-delta {
        font-family: "Bitstream Vera Sans Mono", "DejaVu Sans Mono", Monaco, Courier, monospace;
        font-size: 12px;
        margin: 0;
        padding: 0 0 0 12px;
        display: inline-block;
      }
      .jsondiffpatch-annotated-delta pre {
        font-family: "Bitstream Vera Sans Mono", "DejaVu Sans Mono", Monaco, Courier, monospace;
        font-size: 12px;
        margin: 0;
        padding: 0;
        display: inline-block;
      }
      .jsondiffpatch-annotated-delta td {
        margin: 0;
        padding: 0;
      }
      .jsondiffpatch-annotated-delta td pre:hover {
        font-weight: bold;
      }
      td.jsondiffpatch-delta-note {
        font-style: italic;
        padding-left: 10px;
      }
      .jsondiffpatch-delta-note > div {
        margin: 0;
        padding: 0;
      }
      .jsondiffpatch-delta-note pre {
        font-style: normal;
      }
      .jsondiffpatch-annotated-delta .jsondiffpatch-delta-note {
        color: #777;
      }
      .jsondiffpatch-annotated-delta tr:hover {
        background: #ffc;
      }
      .jsondiffpatch-annotated-delta tr:hover > td.jsondiffpatch-delta-note {
        color: black;
      }
      .jsondiffpatch-error {
        background: red;
        color: white;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div id="scoreboard"></div>
    <div id="change-list"></div>

    <template id="scoreboard-template">
      <table class="scoreboard">
        <tr class="better">
          <td>Better</td>
          <td>{{better}}</td>
        </tr>
        <tr class="worse">
          <td>Worse</td>
          <td>{{worse}}</td>
        </tr>
        <tr class="neutral">
          <td>Neutral</td>
          <td>{{neutral}}</td>
        </tr>
        <tr class="unscored">
          <td>Unscored</td>
          <td>{{unscored}}</td>
        </tr>
      </table>
    </template>

    <template id="change-template">
      <div class="change card">
        <div class="card-text">
          <div class="card request-card">
            <div class="card-header">
              Change {{index}}/{{total}} -
              <a class="btn btn-outline-primary" href="{{oldUrl}}">old: {{oldHost}}</a> -
              <a class="btn btn-outline-primary" href="{{newUrl}}">new: {{newHost}}</a>
            </div>
            <div class="card-text p-2">
              <b><pre>{{params}}</pre></b>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              Delta
            </div>
            <div class="card-text p-2"><div class="delta-visual"></div></div>
          </div>
        </div>

        <div class="d-flex align-items-stretch buttons">
          <button class="btn btn-danger worse">Worse</button>
          <button class="btn btn-secondary neutral">Neutral</button>
          <button class="btn btn-success better">Better</button>
        </div>
      </div>
    </template>

    <script>
      // prettier-ignore
      const json = JSON_GO_HERE;

      const changes = json.changes;

      function renderScoreboard() {
        const scoreboardValues = {
          neutral: 0,
          better: 0,
          worse: 0,
          unscored: 0,
        };

        document
          .querySelectorAll(".change")
          .forEach((node) => (scoreboardValues[node.dataset.quality] += 1));

        var template = document.getElementById("scoreboard-template").innerHTML;
        var renderScoreboardTemplate = Handlebars.compile(template);

        document.getElementById("scoreboard").innerHTML = renderScoreboardTemplate(
          scoreboardValues
        );
      }

      function createElementFromHTML(htmlString) {
        var div = document.createElement("div");
        div.innerHTML = htmlString.trim();

        // Change this to div.childNodes to support multiple top-level nodes
        return div.firstChild;
      }

      const changeList = document.getElementById("change-list");

      var template = document.getElementById("change-template").innerHTML;
      var renderChangeTemplate = Handlebars.compile(template);
      changes.forEach((change, index) => {
        const changeNode = createElementFromHTML(
          renderChangeTemplate({
            index: index + 1,
            total: changes.length,
            params: JSON.stringify(change.params, null, 2),
            oldUrl: change.oldUrl,
            newUrl: change.newUrl,
            oldHost: json.oldApiEnv.host,
            newHost: json.newApiEnv.host,
          })
        );

        changeNode.querySelector(".delta-visual").innerHTML = jsondiffpatch.formatters.html.format(
          change.delta,
          change.old
        );

        changeList.append(changeNode);

        function scoreResult(score) {
          changeNode.dataset.quality = score;

          localStorage.setItem(change.id, score);
        }

        changeNode.dataset.quality = localStorage.getItem(change.id) || "unscored";

        changeNode.querySelector(".better").addEventListener("click", () => scoreResult("better"));
        changeNode.querySelector(".worse").addEventListener("click", () => scoreResult("worse"));
        changeNode
          .querySelector(".neutral")
          .addEventListener("click", () => scoreResult("neutral"));
      });

      renderScoreboard();

      // document.addEventListener("keypress", function onEvent(event) {
      //   console.log(event.key);

      //   const currentElem = 
      //   // if (event.key === "Enter") {
      //   //     // Do something better
      //   // }
      // });
    </script>
  </body>
</html>
